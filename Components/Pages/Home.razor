@page "/"
@using Radzen
@using System.IO
@using EZip.Controller
@inject IJSRuntime JSRuntime
@inject IDirectory s_directory

<div style="display: flex; align-items: center; justify-content: space-between; gap: 5px; padding: 10px;">
    <RadzenButton Text="◀ " ButtonStyle="ButtonStyle.Light" />
    <RadzenTextBox @bind-Value="newPath" Placeholder="输入目标路径" Style="flex-grow: 1;"
                   @onkeydown="HandleKeyDown" />
    <RadzenButton Text="确定" ButtonStyle="ButtonStyle.Primary" Click="ChangePath" />
</div>


<hr />

@if (directoryItems != null)
{
    <h3>当前目录下的内容：</h3>
    <ul>
        @foreach (var item in directoryItems)
        {
            <li>@item</li>
        }
    </ul>
}
else
{
    <p>加载目录失败，或当前目录为空。</p>
}

@code {
    private string currentPath = "C:\\";
    private string newPath = string.Empty;
    private List<string>? directoryItems;

    protected override void OnInitialized()
    {
        currentPath = s_directory.NowPath;
        LoadDirectoryItems(currentPath);
        newPath = currentPath;
    }

    /// <summary>
    /// load the items in the directory
    /// </summary>
    /// <param name="path">total path</param>
    private void LoadDirectoryItems(string path)
    {
        try
        {
            if (Directory.Exists(path))
            {
                var directories = Directory.GetDirectories(path);
                var files = Directory.GetFiles(path);
                directoryItems = directories.Concat(files).ToList();
                currentPath = path;
            }
            else
            {
                directoryItems = null;
                currentPath = "无效路径";
            }
        }
        catch (Exception ex)
        {
            directoryItems = null;
            currentPath = $"错误: {ex.Message}";
        }
        StateHasChanged();
    }

    private void ChangePath()
    {
        if (!string.IsNullOrEmpty(newPath))
        {
            LoadDirectoryItems(newPath);
        }
    }

    /// <summary>
    /// in the case of pressing the Enter key, change the directory  path
    /// </summary>
    private void HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            ChangePath();
        }
    }
}
